---
layout: post
title: "HTB AD Medium: Manager"
description: "Manager is a Medium rated AD machine on HTB."
categories: [CTF,HTB]
tags: [AD,Medium]
author: g
---

## Nmap
![Pasted image 20240714194436.png](/images/Pasted image 20240714194436.png){: .normal }
![Pasted image 20240714194431.png](/images/Pasted image 20240714194431.png){: .normal }

## _**Initial Foothold**_
### Password spraying
We can perform an RID brute attack to obtain valid users in the domain.
![Pasted image 20240714194426.png](/images/Pasted image 20240714194426.png){: .normal }


Add users to file.
![Pasted image 20240714194422.png](/images/Pasted image 20240714194422.png){: .normal }


Try to bruteforce passwords using the username as the password `operator:operator`, `ravan:ravan`.
![Pasted image 20240714194417.png](/images/Pasted image 20240714194417.png){: .normal }


Now that we know we can authenticate via smb we can try authenticating via mssql.
![Pasted image 20240714194413.png](/images/Pasted image 20240714194413.png){: .normal }


Log into the mssql server using the operator user credentials.
![Pasted image 20240714194407.png](/images/Pasted image 20240714194407.png){: .normal width="600" }


We can use the xp_dirtree command to list files.
![Pasted image 20240714194401.png](/images/Pasted image 20240714194401.png){: .normal width="600" }


We can download the backup.zip file by visiting the website.
![Pasted image 20240714194356.png](/images/Pasted image 20240714194356.png){: .normal width="600" }


After unzipping the backup file we find credentials in the old config file `raven:R4v3nBe5tD3veloP3r!123`.
![Pasted image 20240714194350.png](/images/Pasted image 20240714194350.png){: .normal width="600" }


We can use these credentials to get a shell (evil-winrm).
![Pasted image 20240714194345.png](/images/Pasted image 20240714194345.png){: .normal }



## _**Priv Esc**_
Upload certify.exe to abuse ADCS:
![Pasted image 20240714194334.png](/images/Pasted image 20240714194334.png){: .normal width="600" }


Use the following commands found on hacktricks to request the administrator's certificate.
![Pasted image 20240714194330.png](/images/Pasted image 20240714194330.png){: .normal }


Now that we have the administrator's certificate, we can request the administrator hash (make sure to sync time with the DC before requesting the hash).
![Pasted image 20240714194325.png](/images/Pasted image 20240714194325.png){: .normal }


We can gain shell access using the administrator hash.
![Pasted image 20240714194321.png](/images/Pasted image 20240714194321.png){: .normal }


## User.txt
![Pasted image 20240714194316.png](/images/Pasted image 20240714194316.png){: .normal width="500" }


## Root.txt
![Pasted image 20240714194310.png](/images/Pasted image 20240714194310.png){: .normal width="500" }


## You have PWNED!!!
![Pasted image 20240714194305.png](/images/Pasted image 20240714194305.png){: .normal }



### Sources
- [Leak NetNTLM hash via mssql](https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server?source=post_page-----c56f238991c0--------------------------------)
- [Certify exe download](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Certify.exe)
- [Certify request administrator cert](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation)