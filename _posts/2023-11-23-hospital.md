---
layout: post
title: "HTB Windows Medium: Hospital"
description: "Hospital is a Medium rated Windows machine on HTB."
categories: [CTF,HTB]
tags: [Windows,Medium]
author: g
---

## Nmap
![Pasted image 20240714194100.png](/images/Pasted image 20240714194100.png){: .normal }
![Pasted image 20240714194053.png](/images/Pasted image 20240714194053.png){: .normal }

## _**Initial Foothold**_
Reveals domain (DC.hospital.htb & hospital.htb), add the domains to hosts file.
![Pasted image 20240714194048.png](/images/Pasted image 20240714194048.png){: .normal width="400" }


### Enumerating HTTP (Port 8080)
Visiting the webpage redirects us to a login page.
![Pasted image 20240714194042.png](/images/Pasted image 20240714194042.png){: .normal width="500" }


Default credentials don't seem to work (admin:admin), make an account instead.
![Pasted image 20240714194037.png](/images/Pasted image 20240714194037.png){: .normal width="500" }


After logging in we get redirected to the index.php page where we can upload files (we are only allowed to upload image files).
![Pasted image 20240714194030.png](/images/Pasted image 20240714194030.png){: .normal }


We can successfully upload .phar files, uploading our p0wnyshell script results in the following:
![Pasted image 20240714194024.png](/images/Pasted image 20240714194024.png){: .normal }


We can now get a reverse shell.
![Pasted image 20240714194020.png](/images/Pasted image 20240714194020.png){: .normal }


In the config.php file we find some database credentials `root:my$qls3rv1c3!`.
![Pasted image 20240714194014.png](/images/Pasted image 20240714194014.png){: .normal width="600" }


After upgrading our shell we can enumerate further, since the box is running ubuntu with kernel version 5.19 we can use the gameoverlay exploit to become root.
![Pasted image 20240714194010.png](/images/Pasted image 20240714194010.png){: .normal }


In the shadow file we find the password hash for drwilliams.
![Pasted image 20240714194005.png](/images/Pasted image 20240714194005.png){: .normal }


Cracking the password reveals the following `qwe123!@#`.
![Pasted image 20240714193958.png](/images/Pasted image 20240714193958.png){: .normal }


These credentials can be used to log into the web interface that is running on port 443 `drwilliams:qwe123!@#`.
![Pasted image 20240714193954.png](/images/Pasted image 20240714193954.png){: .normal }


On the website we find an email revealing the usage of .eps files and ghostscript.
![Pasted image 20240714193949.png](/images/Pasted image 20240714193949.png){: .normal }


Since we know that the web application is running ghostcript we can look for ghostcript vulnerabillities, use the following commands to create a payload (upload nc.exe).
![Pasted image 20240714193943.png](/images/Pasted image 20240714193943.png){: .normal }


Next up we can upload our payload and send an email to drbrown with our payload attached.
![Pasted image 20240714193938.png](/images/Pasted image 20240714193938.png){: .normal }


Now we can do the same thing for our reverse shell.
![Pasted image 20240714193934.png](/images/Pasted image 20240714193934.png){: .normal }



## _**Priv Esc**_
Once we are in the system we can find chris browns credentials in the ghostscript.bat file `drbrown:chr!$br0wn`.
![Pasted image 20240714193927.png](/images/Pasted image 20240714193927.png){: .normal }


The xampp stack appears to be running as the nt authority/system user. Since we have write permissions over the htdocs directory, we can upload a web shell and get a privileged shell.
![Pasted image 20240714193910.png](/images/Pasted image 20240714193910.png){: .normal }


Looks like we can simply retrieve the root flag.
![Pasted image 20240714193904.png](/images/Pasted image 20240714193904.png){: .normal width="500" }


We now have a shell as the NT authority/SYSTEM user.
![Pasted image 20240714193837.png](/images/Pasted image 20240714193837.png){: .normal width="450"}



## User.txt
![Pasted image 20240714193831.png](/images/Pasted image 20240714193831.png){: .normal width="400"}


## Root.txt
![Pasted image 20240714193824.png](/images/Pasted image 20240714193824.png){: .normal width="500" }


## You have PWNED!!!
![Pasted image 20240714193817.png](/images/Pasted image 20240714193817.png){: .normal }


### Sources
- [p0wnyshell php](https://github.com/flozz/p0wny-shell/blob/master/shell.php)
- [File Upload](https://book.hacktricks.xyz/pentesting-web/file-upload?source=post_page-----791ad6dd24ed--------------------------------)
- [GameOverlay](https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629/blob/main/exploit.sh)
- [Ghostscript CVE](https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection)